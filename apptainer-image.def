Bootstrap: localimage
From: cuda_12.1.1-devel-ubuntu22.04.sif

%files
# Copy the Triton source code to the image
triton /home/tritonuser/triton
py_dependencies /home/tritonuser/py_dependencies
apt_dependencies /home/tritonuser/apt_dependencies
requirements.txt /home/tritonuser/requirements.txt
packages.txt /home/tritonuser/packages.txt


%post
# Use NVIDIA CUDA base image with Ubuntu 22.04

# Set environment variables
DEBIAN_FRONTEND=noninteractive
CMAKE_GENERATOR=Ninja
PATH=/home/tritonuser/.local/bin:$PATH

# Create a non-root user
useradd -m -s /bin/bash tritonuser && \
chown -R tritonuser:tritonuser /home/tritonuser

# Update and install dependencies
dpkg -i ./apt_dependencies/*.deb

# Create a virtual environment for the tritonuser
su -  tritonuser # USER tritonuser
python3 -m venv /home/tritonuser/venv && \
/bin/bash -c "source /home/tritonuser/venv/bin/activate"

pip install --no-index --find-links=/home/tritonuser/py_dependencies -r /home/tritonuser/requirements.txt
cd triton && pip install --no-index --find-links=/home/tritonuser/py_dependencies -e python

# Set the default command
%environment
export DEBIAN_FRONTEND=noninteractive
export CMAKE_GENERATOR=Ninja
export PATH=/home/tritonuser/.local/bin:$PATH
%runscript
exec /bin/bash exec /bin/bash "$@"
%startscript
exec /bin/bash exec /bin/bash "$@"
